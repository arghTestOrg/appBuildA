name: Build and Deploy to EKS

on:
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Build with Maven
      run: mvn clean package

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin

      # Force lowercase on the Docker image tag
    - name: Convert tag to lowercase
      run: |
            LOWERCASE_TAG=$(echo "ghcr.io/arghTestOrg/crud:latest" | tr '[:upper:]' '[:lower:]')
            echo "LOWERCASE_TAG=$LOWERCASE_TAG" >> $GITHUB_ENV

    - name: Build Docker image
      run: docker build -t ${{ env.LOWERCASE_TAG }} .
      
    - name: Push Docker image
      run: docker push ${{ env.LOWERCASE_TAG }}
      

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ASSUMED }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Get Terraform Outputs
      run: |
        aws s3 cp s3://${{ secrets.AWS_BUCKET }}/terraform/state.json state.json
        CLUSTER_NAME=$(jq -r .eks_cluster_name.value state.json)
        CLUSTER_ENDPOINT=$(jq -r .eks_cluster_endpoint.value state.json)

    - name: Update kubeconfig for EKS
      run: |
        aws eks update-kubeconfig --name $CLUSTER_NAME --endpoint $CLUSTER_ENDPOINT --region ${{ secrets.AWS_REGION }}

    - name: Deploy to EKS
      run: |
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
